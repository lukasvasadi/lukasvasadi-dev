<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" href="/vasadi-icon-square.png" />
		
		<link href="./_app/immutable/assets/0.3b8c064f.css" rel="stylesheet">
		<link href="./_app/immutable/assets/3.e2f5fd52.css" rel="stylesheet">
		<link href="./_app/immutable/assets/tag.6154d69e.css" rel="stylesheet">
		<link href="./_app/immutable/assets/linux.d0eb59fd.css" rel="stylesheet">
		<link rel="modulepreload" href="./_app/immutable/entry/start.5b2b6840.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/scheduler.ae1baad1.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/singletons.bb2d775d.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/index.648b4cba.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/control.c2cf8273.js">
		<link rel="modulepreload" href="./_app/immutable/entry/app.b1657c7e.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/preload-helper.a4192956.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/index.0e1198e2.js">
		<link rel="modulepreload" href="./_app/immutable/nodes/0.7f521b39.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/config.f4ded0b2.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/Icon.c2880df6.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/each.e59479a4.js">
		<link rel="modulepreload" href="./_app/immutable/nodes/3.5f886568.js">
		<link rel="modulepreload" href="./_app/immutable/chunks/utils.2fdf1f5e.js"><title>Programming STM32 MCUs</title><!-- HEAD_svelte-1vn9r42_START --><meta property="og:type" content="article"><meta property="og:title" content="Programming STM32 MCUs"><meta property="og:image" content="/images/stm32/low-res/stm32.jpg"><!-- HEAD_svelte-1vn9r42_END --><!-- HEAD_svelte-r30au3_START --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"><!-- HEAD_svelte-r30au3_END --><!-- HEAD_svelte-r30au3_START --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"><!-- HEAD_svelte-r30au3_END --><!-- HEAD_svelte-r30au3_START --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"><!-- HEAD_svelte-r30au3_END --><!-- HEAD_svelte-r30au3_START --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"><!-- HEAD_svelte-r30au3_END --><!-- HEAD_svelte-r30au3_START --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"><!-- HEAD_svelte-r30au3_END -->
		<script type="module">
			const theme = localStorage.getItem('color-scheme')

			theme
				? document.documentElement.setAttribute('color-scheme', theme)
				: localStorage.setItem('color-scheme', 'dark')
		</script>
	</head>
	<body data-sveltekit-preload-data="hover">
		<div style="display: contents">  <div class="layout svelte-sdkn5t"> <nav class="svelte-bs11bt"> <a href="/" class="title svelte-bs11bt"><b>lukasvasadi</b></a>     <button aria-label="Toggle theme" class="svelte-114mtci"><div class="svelte-114mtci"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide-icon lucide lucide-moon "><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg> <span data-svelte-h="svelte-397x2m">Dark</span></div> </button> </nav> <main class="svelte-sdkn5t"> <div class="transition svelte-vcdv4c">  <article class="svelte-1apnuse"> <hgroup><h1 class="svelte-1apnuse">Programming STM32 MCUs</h1> <p class="svelte-1apnuse">Published at Aug 31, 2023</p></hgroup>  <div class="tags svelte-1apnuse"><span class="surface-4 svelte-1apnuse">#STM32</span><span class="surface-4 svelte-1apnuse">#Microcontrollers</span><span class="surface-4 svelte-1apnuse">#Interrupts</span><span class="surface-4 svelte-1apnuse">#Serial</span><span class="surface-4 svelte-1apnuse">#DAC</span></div>  <div class="prose"><p data-svelte-h="svelte-1nc9l3p"><img src="/images/stm32/low-res/stm32.jpg" alt="STM32 Nucleo board"></p> <h2 data-svelte-h="svelte-jpxk5s">Contents</h2> <ul data-svelte-h="svelte-tmpzqw"><li><a href="#introduction">Introduction</a></li> <li><a href="#setup">Setup</a></li> <li><a href="#blink">Blink</a></li> <li><a href="#serial-communication-with-interrupts">Serial communication with interrupts</a></li> <li><a href="#analog-waveform-generator">Analog waveform generator</a></li></ul> <h2><a id="introduction">Introduction</a></h2> <p data-svelte-h="svelte-51q131">This guide details environment setup for programming <a href="https://www.st.com/en/microcontrollers-microprocessors/stm32-32-bit-arm-cortex-mcus.html" rel="nofollow">STM32</a> microcontrollers (MCUs) and reviews general low-level functionality, such as configuring GPIO pins, peripherals, and interrupts. The ST website provides a listing of MCUs based on use case, e.g., “High Performance,” “Ultra Low Power.” However, if unsure about the specific project requirements, simply choose an option from the “Mainstream MCUs.”</p> <p class="tag info svelte-5rv919"><span class="svelte-5rv919"><svg xmlns="http://www.w3.org/2000/svg" width="34px" height="34px" viewBox="0 0 24 24" fill="#5d3af7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide-icon lucide lucide-info "><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg> </span><!-- HTML_TAG_START -->All tutorials in this guide refer to the STM32 <a href="https://www.st.com/en/evaluation-tools/nucleo-g431rb.html">Nucleo-G431RB</a> development board. We will also use the JetBrains CLion IDE instead of the STM32CubeIDE for all development. Source code for the tutorials may be found at <a href="https://github.com/lukasvasadi/stm32-tutorial-source">github.com/lukasvasadi/stm32-tutorial-source</a>.<!-- HTML_TAG_END --> </p> <h3 data-svelte-h="svelte-1ox5jh7">Why use STM32?</h3> <p data-svelte-h="svelte-kyw9z5">STM32 microcontrollers are generally considered an industry standard technology, as opposed to Arduino, which, until the release of the <a href="https://www.arduino.cc/pro/" rel="nofollow">Pro</a> series, has served primarily an educational purpose. Compared to conventional Arduino boards, as well as the multitude of third-party MCU boards created for the Arduino platform, STM32 often provides more performance for substantially less cost. For example, the difference in processing speeds between ST and Arduino dev boards of similar costs can be upwards of 50 MHz.</p> <h3 data-svelte-h="svelte-pglehj">What are the barriers to entry?</h3> <p data-svelte-h="svelte-ff6dr3">Over the years, especially with the introduction of Arduino, MCU development has become simpler and streamlined. This is due to greater abstraction, which no longer requires users to understand the build process. In the case of the Arduino and STM32Cube IDEs, the developer usually selects a board from a preconfigured list and presses “play” to build and flash the chipset.</p> <p data-svelte-h="svelte-1vmdeoa">However, while greater abstraction has certainly made STM32 development approachable, this platform still demands a greater level of understanding, both of the hardware and firmware, than Arduino. Specifically, STM32 development frequently involves configuring low-level pinout functions, clocks, and timers, as well as explicit reading and writing of registers. This can be a daunting task for inexperienced engineers and hobbyists, but with dedication and a little effort, the reward can be extraordinary.</p> <p class="tag info svelte-5rv919"><span class="svelte-5rv919"><svg xmlns="http://www.w3.org/2000/svg" width="34px" height="34px" viewBox="0 0 24 24" fill="#5d3af7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide-icon lucide lucide-info "><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg> </span><!-- HTML_TAG_START -->Even though the STM32 platform requires a deeper understanding of hardware development, I have found that programming more advanced features, such as interrupts, is easier than Arduino.<!-- HTML_TAG_END --> </p> <h2><a id="setup">Setup</a></h2> <p data-svelte-h="svelte-1n5c3d4">This setup is suitable for Windows, Linux, and macOS. The main requirements are as follows:</p> <ul data-svelte-h="svelte-1c7wpuy"><li><strong>STM32CubeMX</strong> Graphical tool for configuring STM32 microcontrollers</li> <li><strong>GNU ARM toolchain</strong> Cross-platform toolchain for compiling C/C++ source</li> <li><strong>OpenOCD</strong> Open-source debugger software for microcontrollers</li> <li><strong>CLion</strong> JetBrains IDE for C/C++ development (optional)</li></ul> <h3 data-svelte-h="svelte-11sfqkb">STM32CubeMX</h3> <p data-svelte-h="svelte-112j9av"><a href="https://www.st.com/en/development-tools/stm32cubemx.html" rel="nofollow">STM32CubeMX</a> is a graphical tool that guides the user through standard project setup. Download and run the platform-specific installer from the product web page, but note that macOS may require additional permissions. If you have trouble, refer to the <code>Readme.html</code> document that ships with the software.</p> <p data-svelte-h="svelte-jlhsy0">To configure a project, first select the chipset or board, e.g., the Nucleo-G431RB, and press “Start Project” in the upper right-hand corner, where you will be directed to a graphical representation of the MCU pinout.</p> <p data-svelte-h="svelte-1sh19qn"><img src="/images/stm32/low-res/stm32cubemx_board_selector.png" alt="STM32CubeMX board selector window"></p> <p data-svelte-h="svelte-63amuw">In MCU pinout, green highlighting indicates that the pin has an assigned function, e.g., USART, GPIO. When a function is assigned, the user can modify its behavior through various options in the left-hand pane. As shown below, by default, pin PA5 is connected to the onboard green LED (LD2).</p> <p data-svelte-h="svelte-ser4xf"><img src="/images/stm32/low-res/stm32cubemx_pinout_config.png" alt="STM32CubeMX pin configuration window"></p> <p data-svelte-h="svelte-im8w8h"><img src="/images/stm32/low-res/stm32cubemx_project_manager.png" alt="STM32CubeMX project manager window"></p> <h3 data-svelte-h="svelte-17a8ahz">GNU Arm embedded toolchain</h3> <h4 data-svelte-h="svelte-a506pd">Windows</h4> <p data-svelte-h="svelte-8r6mlz">The GNU embedded toolchain for Arm microcontrollers can be installed via the executable from <a href="https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-rm/downloads" rel="nofollow">armDeveloper</a>. Alternatively, install via Chocolatey:</p> <!-- HTML_TAG_START --><pre class="shiki one-dark-pro" style="background-color: #282c34" tabindex="0"><code><span class="line"><span style="color: #ABB2BF">choco install gcc</span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">arm</span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">embedded</span></span></code></pre><!-- HTML_TAG_END --> <h4 data-svelte-h="svelte-dikflg">Linux</h4> <!-- HTML_TAG_START --><pre class="shiki one-dark-pro" style="background-color: #282c34" tabindex="0"><code><span class="line"><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">apt</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">install</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">gcc-arm-none-eabi</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">gdb-multiarch</span></span></code></pre><!-- HTML_TAG_END --> <h4 data-svelte-h="svelte-1f4vatt">macOS</h4> <!-- HTML_TAG_START --><pre class="shiki one-dark-pro" style="background-color: #282c34" tabindex="0"><code><span class="line"><span style="color: #61AFEF">brew</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">install</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">--cask</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">gcc-arm-embedded</span></span></code></pre><!-- HTML_TAG_END --> <h3 data-svelte-h="svelte-1o7e2pg">OpenOCD</h3> <p data-svelte-h="svelte-rsanli">The Open On-Chip Debugger (OpenOCD) is an open-source software package for programming and debugging specific embedded hardware systems. It may be used to configure JetBrains CLion (see below) for STM32 development.</p> <h4 data-svelte-h="svelte-a506pd">Windows</h4> <!-- HTML_TAG_START --><pre class="shiki one-dark-pro" style="background-color: #282c34" tabindex="0"><code><span class="line"><span style="color: #ABB2BF">choco install openocd</span></span></code></pre><!-- HTML_TAG_END --> <h4 data-svelte-h="svelte-dikflg">Linux</h4> <!-- HTML_TAG_START --><pre class="shiki one-dark-pro" style="background-color: #282c34" tabindex="0"><code><span class="line"><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">apt</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">install</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">openocd</span></span></code></pre><!-- HTML_TAG_END --> <h4 data-svelte-h="svelte-1f4vatt">macOS</h4> <!-- HTML_TAG_START --><pre class="shiki one-dark-pro" style="background-color: #282c34" tabindex="0"><code><span class="line"><span style="color: #61AFEF">brew</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">install</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">openocd</span></span></code></pre><!-- HTML_TAG_END -->  <h3 data-svelte-h="svelte-168lvrd">JetBrains CLion IDE</h3> <p data-svelte-h="svelte-1foz4h8">ST provides an Eclipse-based IDE (<a href="https://www.st.com/en/development-tools/stm32cubeide.html" rel="nofollow">STM32CubeIDE</a>) for its microcontrollers and development boards. This IDE integrates with the STM32CubeMX graphical tool for initializing MCU pin configurations. Although the ST-supported IDE has many platform-specific features, I prefer JetBrains CLion for its stronger C/C++ language support and cleaner UI. In addition, the JetBrains developers created seemless integration with STM32CubeMX. You can download the software with a free 30-day trial from <a href="https://www.jetbrains.com/clion/" rel="nofollow">jetbrains.com/clion</a>.</p> <p data-svelte-h="svelte-13xxkx3">A complete guide to configuring CLion for STM32 can be found at <a href="https://www.jetbrains.com/help/clion/embedded-development.html" rel="nofollow">STM32CubeMX projects</a>. Once you have installed the compiler toolchain and dependencies, and configured the IDE, you are ready to begin development!</p> <h2><a id="blink">Blink</a></h2> <p data-svelte-h="svelte-hvt1hj">With the default pin configuration, we have access to the onboard green LED (LD2) via GPIO PA5. To blink the LED, we need to modify the <code>Core/Src/main.c</code> file, specifically calling the pin toggle function in the infinite loop:</p> <!-- HTML_TAG_START --><pre class="shiki one-dark-pro" style="background-color: #282c34" tabindex="0"><code><span class="line"><span style="color: #7F848E; font-style: italic">/* Infinite loop */</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">/* USER CODE BEGIN WHILE */</span></span>
<span class="line"><span style="color: #C678DD">while</span><span style="color: #ABB2BF"> (</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">) &#123;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">HAL_GPIO_TogglePin</span><span style="color: #ABB2BF">(GPIOA, GPIO_PIN_5);</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">HAL_Delay</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">2000</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    /* USER CODE END WHILE */</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    /* USER CODE BEGIN 3 */</span></span>
<span class="line"><span style="color: #ABB2BF">&#125;</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">/* USER CODE END 3 */</span></span></code></pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-1ng9gzr">In the above code sample, the “HAL” function prefix is an acronym for “Hardware Abstraction Layer,” which is a large ST library of convenience functions for controlling peripherals.</p> <h2><a id="serial-communication-with-interrupts">Serial communication with interrupts</a></h2> <p data-svelte-h="svelte-1rlx8nk">In this section, we will configure the Nucleo-G431RB for serial communication with interrupts. In the infinite loop, the MCU will continue running the blink routine from the example above, but upon receiving serial input, the processor will stop execution on the main thread and run a dedicated event handler function.</p> <p data-svelte-h="svelte-1gk7j3t">To begin, we have to contigure the pinout for <strong>USART1</strong>, which stands for “Universal Synchronous Asynchronous Receiver Transmitter.”</p> <p data-svelte-h="svelte-1kuitbu"><img src="/images/stm32/low-res/stm32cubemx_serial_interrupt_config.png" alt="STM32CubeMX serial interrupt configuration"></p> <p data-svelte-h="svelte-15zrrup">The example below shows the source code for interrupting the main thread based on incoming serial data. This data is then used to determine the toggle state of two GPIO pins.</p> <!-- HTML_TAG_START --><pre class="shiki one-dark-pro" style="background-color: #282c34" tabindex="0"><code><span class="line"><span style="color: #7F848E; font-style: italic">/*</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    Serial pin control</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    Toggle GPIO pins based on serial input</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">*/</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">uint8_t</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">rx_data</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">2</span><span style="color: #ABB2BF">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">() &#123;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">MX_GPIO_Init</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">MX_USART2_UART_Init</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">HAL_UART_Receive_IT</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">&amp;</span><span style="color: #ABB2BF">huart2, rx_data, </span><span style="color: #D19A66">2</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">HAL_GPIO_WritePin</span><span style="color: #ABB2BF">(GPIOA, GPIO_PIN_9, GPIO_PIN_RESET);</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">HAL_GPIO_WritePin</span><span style="color: #ABB2BF">(GPIOA, GPIO_PIN_10, GPIO_PIN_RESET);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">while</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">) &#123;</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">HAL_Delay</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">10</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">    &#125;</span></span>
<span class="line"><span style="color: #ABB2BF">&#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">void</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">HAL_UART_RxCpltCallback</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">UART_HandleTypeDef </span><span style="color: #C678DD">*</span><span style="color: #E06C75; font-style: italic">huart</span><span style="color: #ABB2BF">) &#123;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #7F848E; font-style: italic">// Prevent unused argument(s) compilation warnings</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">UNUSED</span><span style="color: #ABB2BF">(huart);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E5C07B">huart</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #E06C75">Instance</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">==</span><span style="color: #ABB2BF"> USART2) &#123;</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #7F848E; font-style: italic">// Receive with interrupt</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">HAL_UART_Receive_IT</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">&amp;</span><span style="color: #ABB2BF">huart2, rx_data, </span><span style="color: #D19A66">2</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #7F848E; font-style: italic">// Toggle pin 9 based on input from data buffer at position 0</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">rx_data</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">] </span><span style="color: #C678DD">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">49</span><span style="color: #ABB2BF">) </span><span style="color: #61AFEF">HAL_GPIO_WritePin</span><span style="color: #ABB2BF">(GPIOA, GPIO_PIN_9, GPIO_PIN_SET);</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">else</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">HAL_GPIO_WritePin</span><span style="color: #ABB2BF">(GPIOA, GPIO_PIN_9, GPIO_PIN_RESET);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #7F848E; font-style: italic">// Toggle pin 10 based on input from data buffer at position 1</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">rx_data</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">] </span><span style="color: #C678DD">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">49</span><span style="color: #ABB2BF">) </span><span style="color: #61AFEF">HAL_GPIO_WritePin</span><span style="color: #ABB2BF">(GPIOA, GPIO_PIN_10, GPIO_PIN_SET);</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">else</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">HAL_GPIO_WritePin</span><span style="color: #ABB2BF">(GPIOA, GPIO_PIN_10, GPIO_PIN_RESET);</span></span>
<span class="line"><span style="color: #ABB2BF">    &#125;</span></span>
<span class="line"><span style="color: #ABB2BF">&#125;</span></span></code></pre><!-- HTML_TAG_END --> <h2><a id="analog-waveform-generator">Analog waveform generator</a></h2> <p data-svelte-h="svelte-1r9jgoj">In this section, we will configure the microcontroller digital-to-analog converter (DAC) peripheral to output an analog waveform based on a lookup table stored in direct memory access (DMA). Reading the voltage level from DMA to the DAC output register (DOC) completely sidesteps the CPU, preventing MCU throttling and improving speed.</p> <p data-svelte-h="svelte-5rjoba">The lookup table contains an array of unsigned integers corresponding to the voltage levels at each point in a waveform cycle (0, 2π). The length of the array corresponds to the signal resolution. The waveform frequency will depend on the MCU timer signal, which drives the transfer of data points from DMA to DOC. The DMA must be configured to operate in “circular mode” to produce a continuous output signal.</p> <p data-svelte-h="svelte-1mq6x7p">In this example, we will generate the data points in the CPU at startup; however, you may also generate the lookup table beforehand and add the data directly.</p> <h3 data-svelte-h="svelte-y0coh2">Calculating the lookup table</h3> <p>Below is a source code snippet that can be integrated into the MCU startup routine. It calculates an output voltage level,  <!-- HTML_TAG_START --><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">{V}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span><!-- HTML_TAG_END -->, based on the number of samples,  <!-- HTML_TAG_START --><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">{N}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span><!-- HTML_TAG_END -->, and DAC resolution,  <!-- HTML_TAG_START --><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">{R}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span></span><!-- HTML_TAG_END -->.</p> <!-- HTML_TAG_START --><pre class="shiki one-dark-pro" style="background-color: #282c34" tabindex="0"><code><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;stdint.h&gt;</span></span>
<span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;math.h&gt;</span></span>
<span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;stdio.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF">&#123;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">uint8_t</span><span style="color: #ABB2BF"> N </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">128</span><span style="color: #ABB2BF">;</span><span style="color: #7F848E; font-style: italic">  // Number of sample points</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">uint8_t</span><span style="color: #ABB2BF"> R </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">12</span><span style="color: #ABB2BF">;</span><span style="color: #7F848E; font-style: italic"> // DAC resolution</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">float</span><span style="color: #ABB2BF"> step </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (</span><span style="color: #D19A66">2</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">*</span><span style="color: #ABB2BF"> M_PI) </span><span style="color: #C678DD">/</span><span style="color: #ABB2BF"> (N </span><span style="color: #C678DD">-</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">float</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">T</span><span style="color: #ABB2BF">[n];</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">float</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">V</span><span style="color: #ABB2BF">[n];</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> (</span><span style="color: #C678DD">uint8_t</span><span style="color: #ABB2BF"> i </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">; i </span><span style="color: #C678DD">&lt;</span><span style="color: #ABB2BF"> N; i</span><span style="color: #C678DD">++</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">    &#123;</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">T</span><span style="color: #ABB2BF">[i] </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> i </span><span style="color: #C678DD">*</span><span style="color: #ABB2BF"> step;</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">V</span><span style="color: #ABB2BF">[i] </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (</span><span style="color: #61AFEF">sin</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">T</span><span style="color: #ABB2BF">[i]) </span><span style="color: #C678DD">+</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">*</span><span style="color: #ABB2BF"> (</span><span style="color: #61AFEF">pow</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">2</span><span style="color: #ABB2BF">, R) </span><span style="color: #C678DD">-</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">printf</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;</span><span style="color: #D19A66">%.6f</span><span style="color: #56B6C2">&#92;n</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">, </span><span style="color: #61AFEF">round</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">V</span><span style="color: #ABB2BF">[i]));</span></span>
<span class="line"><span style="color: #ABB2BF">    &#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">&#125;</span></span></code></pre><!-- HTML_TAG_END --> <h3 data-svelte-h="svelte-161aj6p">Calculating frequency</h3>  <!-- HTML_TAG_START --><div style="overflow-x:auto;" class="mathlifier-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>f</mi><mi>t</mi></msub><mo>=</mo><mfrac><msub><mi>f</mi><mrow><mi>c</mi><mi>l</mi><mi>k</mi></mrow></msub><mrow><mo stretchy="false">(</mo><mi>P</mi><mi>S</mi><mi>C</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mi>A</mi><mi>R</mi><mi>R</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">f_t=\frac{f_{clk}}{(PSC+1)(ARR+1)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.3074em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">PSC</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.00773em;">RR</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></div><!-- HTML_TAG_END -->  <!-- HTML_TAG_START --><div style="overflow-x:auto;" class="mathlifier-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>f</mi><mi>o</mi></msub><mo>=</mo><mfrac><msub><mi>f</mi><mi>t</mi></msub><mi>n</mi></mfrac></mrow><annotation encoding="application/x-tex">f_o=\frac{f_t}{n}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0574em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">n</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></div><!-- HTML_TAG_END --></div> </article></div></main>   <footer class="svelte-k2ae0s"><p class="svelte-k2ae0s">lukasvasadi © 2024</p> </footer> </div> 
			
			<script>
				{
					__sveltekit_v6k3x0 = {
						base: new URL(".", location).pathname.slice(0, -1),
						env: {}
					};

					const element = document.currentScript.parentElement;

					const data = [null,null];

					Promise.all([
						import("./_app/immutable/entry/start.5b2b6840.js"),
						import("./_app/immutable/entry/app.b1657c7e.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 3],
							data,
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
	</body>
</html>
